<script>
/* ===================== CORE DATA ===================== */
let soundEnabled = false;
const sfx_click = new Audio('https://www.soundjay.com/buttons/sounds/button-37a.mp3');

let data = {
  score: 0,
  power: 1,
  pwrCost: 15,
  auto: 0,
  autoCost: 100
};

const SAVE_KEY = "dalton_countryball_save";
let babyMode = false;

/* ===================== 200+ COUNTRY CODES ===================== */
const allCodes = [];
const letters = "abcdefghijklmnopqrstuvwxyz";
for(let a of letters){
  for(let b of letters){
    allCodes.push(a+b);
  }
}

/* ===================== SAVE / LOAD ===================== */
function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function load() {
  try {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) data = JSON.parse(saved);
  } catch(e) {
    console.warn("Save error, resetting.");
    localStorage.removeItem(SAVE_KEY);
  }
  refresh();
}

/* ===================== COUNTRY SYSTEM ===================== */
function updateCountry() {
  const idx = Math.floor(data.score / 1000);
  const code = allCodes[idx % allCodes.length];
  const flag = document.getElementById("country-flag");

  flag.src = `https://flagcdn.com/w320/${code}.png`;
  flag.onerror = () => {
    flag.src = "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";
  };

  document.getElementById("location-name").textContent = code.toUpperCase();
}

/* ===================== UI REFRESH ===================== */
function refresh() {
  document.getElementById('score-val').textContent = Math.floor(data.score).toLocaleString();
  document.getElementById('pwr-cost').textContent = data.pwrCost.toLocaleString();
  document.getElementById('auto-cost').textContent = data.autoCost.toLocaleString();
  document.getElementById('buy-pwr').disabled = data.score < data.pwrCost;
  document.getElementById('buy-auto').disabled = data.score < data.autoCost;
  updateCountry();
}

/* ===================== POPUP ===================== */
function spawnPopup(x, y, val) {
  const p = document.createElement('div');
  p.className = 'popup';
  p.style.left = x + 'px';
  p.style.top = y + 'px';
  p.innerText = `+$${val}`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

/* ===================== EMOTIONS ===================== */
const emotions = ["neutral","happy","sad","angry","idle"];

function randomEmotion() {
  const ball = document.getElementById("ball");
  ball.classList.remove(...emotions);
  const emo = emotions[Math.floor(Math.random() * emotions.length)];
  ball.classList.add(emo);
}

/* ===================== MUTATIONS ===================== */
function tryMutation() {
  const ball = document.getElementById("ball");
  ball.classList.remove("mutated","golden");

  if(Math.random() < 0.02) { // 2%
    ball.classList.add("mutated");
  }
  if(Math.random() < 0.005) { // 0.5%
    ball.classList.add("golden");
  }
}

/* ===================== CLICK HANDLER ===================== */
document.getElementById('ball').addEventListener('click', (e) => {
  if(babyMode) return;

  soundEnabled = true;
  data.score += data.power;

  try {
    sfx_click.currentTime = 0;
    sfx_click.play();
  } catch {}

  spawnPopup(e.clientX, e.clientY, data.power);
  randomEmotion();
  tryMutation();
  refresh();
  save();
});

/* ===================== UPGRADES ===================== */
document.getElementById('buy-pwr').onclick = () => {
  if(data.score >= data.pwrCost) {
    data.score -= data.pwrCost;
    data.power++;
    data.pwrCost = Math.round(data.pwrCost * 1.4);
    refresh();
    save();
  }
};

document.getElementById('buy-auto').onclick = () => {
  if(data.score >= data.autoCost) {
    data.score -= data.autoCost;
    data.auto++;
    data.autoCost = Math.round(data.autoCost * 1.6);
    refresh();
    save();
  }
};

/* ===================== AUTO INCOME ===================== */
setInterval(() => {
  if(data.auto > 0 && !babyMode) {
    data.score += data.auto;
    refresh();
  }
}, 1000);

/* ===================== BABY MODE ===================== */
function toggleBabyMode() {
  const baby = document.getElementById('baby-version');
  babyMode = !babyMode;
  baby.style.display = babyMode ? 'flex' : 'none';
}

/* ===================== RESET ===================== */
function resetAll() {
  if(confirm("Erase all progress?")) {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }
}

load();
</script>
