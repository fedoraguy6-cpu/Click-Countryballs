<script>
let soundEnabled = false;
const sfx_click = new Audio('https://www.soundjay.com/buttons/sounds/button-37a.mp3');

let data = {
  score: 0,
  power: 1,
  pwrCost: 15,
  auto: 0,
  autoCost: 100
};

const SAVE_KEY = "dalton_final_save";

const countries = [
  {code:"my", name:"MALAYSIA"},
  {code:"gb", name:"UK"},
  {code:"ca", name:"CANADA"},
  {code:"au", name:"AUSTRALIA"},
  {code:"de", name:"GERMANY"},
  {code:"fr", name:"FRANCE"},
  {code:"it", name:"ITALY"},
  {code:"jp", name:"JAPAN"},
  {code:"cn", name:"CHINA"},
  {code:"ru", name:"RUSSIA"},
  {code:"br", name:"BRAZIL"},
  {code:"mx", name:"MEXICO"},
  {code:"es", name:"SPAIN"},
  {code:"pl", name:"POLAND"},
  {code:"ua", name:"UKRAINE"},
  {code:"tr", name:"TURKEY"},
  {code:"kr", name:"KOREA"},
  {code:"se", name:"SWEDEN"},
  {code:"no", name:"NORWAY"},
  {code:"fi", name:"FINLAND"}
];

let babyMode = false;

function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function load() {
  try {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) data = JSON.parse(saved);
  } catch {
    console.warn("Save corrupted, resetting.");
    localStorage.removeItem(SAVE_KEY);
  }
  refresh();
}

function refresh() {
  document.getElementById('score-val').textContent = Math.floor(data.score).toLocaleString();
  document.getElementById('pwr-cost').textContent = data.pwrCost.toLocaleString();
  document.getElementById('auto-cost').textContent = data.autoCost.toLocaleString();
  document.getElementById('buy-pwr').disabled = data.score < data.pwrCost;
  document.getElementById('buy-auto').disabled = data.score < data.autoCost;

  let idx = Math.min(Math.floor(data.score / 1000), countries.length - 1);
  const c = countries[idx];
  document.getElementById('country-flag').src = `https://flagpedia.net/data/flags/w580/${c.code}.png`;
  document.getElementById('location-name').textContent = c.name;
}

document.getElementById('ball').addEventListener('click', (e) => {
  if(babyMode) return;

  soundEnabled = true;
  data.score += data.power;

  if(soundEnabled) {
    sfx_click.currentTime = 0;
    sfx_click.play().catch(()=>{});
  }

  spawnPopup(e.clientX, e.clientY, data.power);
  refresh();
  save();
});

document.getElementById('buy-pwr').onclick = () => {
  if(data.score >= data.pwrCost) {
    data.score -= data.pwrCost;
    data.power++;
    data.pwrCost = Math.round(data.pwrCost * 1.4);
    refresh(); save();
  }
};

document.getElementById('buy-auto').onclick = () => {
  if(data.score >= data.autoCost) {
    data.score -= data.autoCost;
    data.auto += 1;
    data.autoCost = Math.round(data.autoCost * 1.6);
    refresh(); save();
  }
};

function spawnPopup(x, y, val) {
  const p = document.createElement('div');
  p.className = 'popup';
  p.style.left = x + 'px';
  p.style.top = y + 'px';
  p.innerText = `+$${val}`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

setInterval(() => {
  if(data.auto > 0 && !babyMode) {
    data.score += data.auto;
    refresh();
  }
}, 1000);

function toggleBabyMode() {
  const baby = document.getElementById('baby-version');
  babyMode = !babyMode;
  baby.style.display = babyMode ? 'flex' : 'none';
}

function resetAll() {
  if(confirm("Erase all progress?")) {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }
}

load();
</script>
